angular.module("pi.upload",[]).constant("piUploadConfig",{forceIFrameUpload:!1,url:"/upload",method:"post",multiple:!0,name:"file",iframeName:"piUploadIframe",data:{},start:null,success:angular.noop,error:angular.noop,progress:angular.noop}).directive("piUpload",["piUploadConfig","piUpload",function(a,b){return{restrict:"A",scope:{options:"=piUpload"},link:function(c,d){function f(a){var b=a[0].getBoundingClientRect();return{width:b.width||a.prop("offsetWidth"),height:b.height||a.prop("offsetHeight")}}var g=d.find("button"),h=angular.element('<input type="file">'),i=f(g);a=angular.copy(a),angular.extend(a,c.options),d.css({position:"relative"}),h.css({position:"absolute",display:"block",left:0,top:0,opacity:0,width:i.width+"px",filter:"alpha(opacity=0)",height:i.height+"px"}).attr({multiple:a.multiple,name:a.name}),d.append(h),d.on("click",function(){var c=d.find("input");c.on("change",function(){a.data[a.name]=c,b(a),c.off("change")})})}}}]).factory("piFormDataUpload",["$http","$timeout",function(a,b){return function(a){var c=new XMLHttpRequest,d=new FormData;a.start&&b(a.start),angular.forEach(a.data,function(b,c){c==a.name?(b=b[0].files,b.length>1?angular.forEach(b,function(a,b){d.append(c+"["+b+"]",a)}):d.append(c,b[0])):d.append(c,b)}),c.upload.addEventListener("progress",function(c){b(function(){a.progress(c)})},!1),c.addEventListener("load",function(c){b(function(){var b=c.target.responseText;try{a.success(angular.fromJson(b))}catch(d){a.error(b)}})},!1),c.open(a.method,a.url),c.send(d)}}]).factory("piIframeUpload",["$timeout",function(a){return function(b){var c=angular.element(document.body),d=angular.element('<iframe name="piUploadIframe">'),e=angular.element("<form>");b.start&&a(b.start),e.attr({target:"piUploadIframe",enctype:"multipart/form-data",method:b.method,action:b.url}).css({display:"none"}),angular.forEach(b.data,function(a,c){var d;c==b.name?(d=a.clone().attr("multiple",!1),a.after(d),e.append(a)):(d=angular.element('<input type="hidden">'),d.attr({name:c,value:a}),e.append(d))}),e.append(d),c.append(e),d.on("load",function(){var c=this.contentWindow?this.contentWindow.document:this.contentDocument,f=angular.element(c.body).text();a(function(){try{b.success(angular.fromJson(f))}catch(a){b.error(f)}}),d.off("load"),e.remove()}),e[0].submit()}}]).factory("piUpload",["piFormDataUpload","piIframeUpload",function(a,b){function d(d){if(c.XHR){var e=new XMLHttpRequest;c.progress=!d.forceIFrameUpload&&c.formData&&e.upload}c.progress?a(d):b(d)}var c={formData:window.FormData,XHR:window.XMLHttpRequest,progress:!1};return d.support=c,d}]);